# Chpater5_2 트랜잭션 서비스 추상화

<br>

## 💭 시스템 작업 중 예외가 발생해서 작업이 중단된다면 어떻게 될까?


트랜잭션이란 저 이상 나눌 수 없는 단위 작업을 말한다. 

➡   작업을 쪼개서 작은 단위로 만들 수 없다는 것은 **트랜잭션의 핵심 속성**인 `원자성`을 의미한다. ︎ 


### 🔎 작업을 완료할 수 없다면 아예 <ins>**작업이 시작되지 않은 것 처럼 초기 상태**</ins>로 돌려놔야 한다. 
### [대표적인 예시 : 은행 계좌 이체]


<br>

### 트랜잭션 경계 설정

**요청 `취소` 작업 ➡  트랜잭션 롤백**

**요청 수행 `성공` ➡ 트랜잭션 커밋**

<br>

> **트랜잭션의 경계설정** 
> 
> 모든 트랜잭션은 시작하는 지점과 끝나는 지점이 있다.  
> 
> ➡ 해당 지점을 설정하는 것이 트랜잭션의 경계설정이다. 
> 
> 💡 애플리케이션 내에서 **트랜잭션이 시작되고 끝나는 위치**를 <span style="color:orange;">**트랜잭션 경계**</span>라고 부른다. 

### 하나의 DB 커넥션 안에서 만들어지는 트랜잭션을 `로컬 트랜잭션`이라고 한다.


<br>

> DAO 메소드의 경우 **DB 커넥션을 매번 만들기 때문에** <ins>**트랜잭션이 매 메소드마다 존재할 수 밖에 없다.**</ins> 

### 💭 만약 여러번의 DB 업데이트를 해야한다면 트랜잭션을 어떻게 설정해야할까? 

#### 비즈니스 로직에 담는다면 하나의 DB커넥션으로 작업을 관리할 수 있다.


<br>

### 트랜잭션 동기화 

트랜잭션을 시작하기 위해 만든 **Connection 오브젝트를 특별한 저장소에 보관**해두고, 이 후 호출되는 **DAO의 메소드에서 해당 Connection을 가져와서 사용**하게 하는 것 

<br>

**[트랜잭션 동기화 특징]**

`스프링`은 **트랜잭션 동기화 매니저를 제공**한다. 

이것을 `Local Thread`을 사용해서 **커넥션 동기화를 진**행한다. 

➡︎ **트랜잭션 매니저는 내부에서 이 트랜잭션 동기화 매니저를 사용한다.** 

Local Thread를 사용하면 <ins>**각각의 쓰레드마다 별도의 저장소가 부여**</ins>된다. 또한 해당 Thread만 데이터에 접근할 수 있도록 하기 때문에 <span style="color:orange;">**멀티쓰레드 상황에 안전하게 커넥션을 동기화할 수 있다.**</span> **(충돌 ❌)** 

**따라서 커넥션이 필요하면 트랜잭션 동기화 매니저를 통해 커넥션을 획득하면 된다.** 


<br>

> 🚨 다만, 이러한 로컬 쓰레드는 **독립적으로 동작**하기 때문에 <span style="color:#F05750;">**여러 DB 연결은 불가능**</span> 하다. 


<br>

### 글로벌 트랜잭션 

트랜잭션 매니저를 통해 여러개의 DB가 참여하는 작업을 하나의 트랜잭션으로 만들 수 있다.  (자바는 JTA를 제공한다.)


> **💡 단일 책임 원칙 SRP(Singel Responseibility Priciple)** 
> 
> ➡︎ 하나의 모듈은 한 가지 책임을 가져야 한다. 





